{{/*
  External Link Handler
  =====================

  This template automatically handles external links with configurable attributes based on domain rules.

  Default Behavior (no configuration required):
  - QualityUnit domains: target="_blank" + rel="noopener noreferrer" (no nofollow for SEO)
  - Current site domain: automatically detected, no nofollow
  - Other domains: target="_blank" + rel="nofollow noopener noreferrer" (prevents crawling costs)

  QualityUnit Domains (hardcoded):
  - qualityunit.com
  - support.qualityunit.com
  - liveagent.com
  - flowhunt.io
  - postaffiliatepro.com
  - helpdesk.com
  - aimingle.cz
  - photomaticai.com
  - urlslab.com

  Optional Configuration in params.toml:

  [params.externalLinks]
    nofollow = false  # Global disable nofollow (default: true)

    [params.externalLinks.domainRules]
      "docs.google.com" = { target = "_self", rel = "" }
      "youtube.com" = { target = "_blank", rel = "nofollow noopener" }
      "support.qualityunit.com" = { target = "_self", rel = "noopener" }

  Rule Priority:
  1. Custom domainRules configuration
  2. Current site domain (auto-detected from site.BaseURL)
  3. Default QualityUnit domains (hardcoded)
  4. Fallback for other domains (uses nofollow parameter)

  Examples:
  - Link to liveagent.com -> target="_blank" rel="noopener noreferrer"
  - Link to current site -> target="_blank" rel="noopener noreferrer"
  - Link to google.com -> target="_blank" rel="nofollow noopener noreferrer"
  - Custom rule override -> uses specified target/rel values
*/}}

{{- $url := .Destination -}}
{{- $isExternal := hasPrefix $url "http://" | or (hasPrefix $url "https://") -}}

{{- $target := "" -}}
{{- $rel := "" -}}

{{- if $isExternal -}}
  {{- $parsedURL := urls.Parse site.BaseURL -}}
  {{- $currentDomain := $parsedURL.Host -}}

  {{- $defaultDomainRules := dict
    "qualityunit.com" (dict "target" "_blank" "rel" "noopener noreferrer")
    "support.qualityunit.com" (dict "rel" "noopener noreferrer")
    "liveagent.com" (dict "target" "_blank" "rel" "noopener noreferrer")
    "flowhunt.io" (dict "target" "_blank" "rel" "noopener noreferrer")
    "postaffiliatepro.com" (dict "target" "_blank" "rel" "noopener noreferrer")
    "helpdesk.com" (dict "target" "_blank" "rel" "noopener noreferrer")
    "aimingle.cz" (dict "target" "_blank" "rel" "noopener noreferrer")
    "photomaticai.com" (dict "target" "_blank" "rel" "noopener noreferrer")
    "urlslab.com" (dict "target" "_blank" "rel" "noopener noreferrer")
  -}}

  {{- $customDomainRules := site.Params.externalLinks.domainRules | default dict -}}
  {{- $domainRules := merge $defaultDomainRules $customDomainRules -}}

  {{- $matchedRule := false -}}
  {{- range $domain, $rule := $domainRules -}}
    {{- if and (not $matchedRule) (strings.Contains $url $domain) -}}
      {{- $target = $rule.target -}}
      {{- $rel = $rule.rel -}}
      {{- $matchedRule = true -}}
    {{- end -}}
  {{- end -}}

  {{- if and (not $matchedRule) (strings.Contains $url $currentDomain) -}}
    {{- $target = "_blank" -}}
    {{- $rel = "noopener noreferrer" -}}
    {{- $matchedRule = true -}}
  {{- end -}}

  {{- if not $matchedRule -}}
    {{- $useNofollow := site.Params.externalLinks.nofollow | default true -}}
    {{- $target = "_blank" -}}
    {{- $rel = cond $useNofollow "nofollow noopener noreferrer" "noopener noreferrer" -}}
  {{- end -}}
{{- end -}}

<a href="{{ $url }}"
   {{- if $target }} target="{{ $target }}"{{ end }}
   {{- if $rel }} rel="{{ $rel }}"{{ end }}
   {{- with .Title }} title="{{ . }}"{{ end -}}>
   {{- .Text -}}
</a>