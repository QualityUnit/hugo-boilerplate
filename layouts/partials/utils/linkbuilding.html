{{/*
@component: Linkbuilding
@description: Processes HTML content to add links based on keywords defined in data/linkbuilding/[lang].yaml.
@params:
  a dict with:
    - content: The HTML content to process
    - page: The page context for tracking processed links
@example:
  {{ $processedContent := partial "utils/linkbuilding" (dict "content" .Content "page" .) }}

@note: This utility enhances content by adding contextual links based on defined keywords. It prevents duplicate links and ensures proper HTML structure.

@configuration: Settings can be configured in config/_default/params.toml under [params.linkbuilding]:
  maxSameKeywordReplacementsInPage = 5       # Maximum times the same keyword can be linked per page
  maxSameUrlReplacementsInPage = 3            # Maximum times the same URL can be linked per page
  maxKeywordUrlReplacementsInPage = 1         # Maximum times the same keyword-URL combination can be linked per page
  charactersPerLinkInParagraphDensity = 5     # Maximum characters per link density to prevent too many links in short text
  maxAutomaticLinksInPage = 50                # Maximum total automatic links per page
  maxAutomaticLinksInParagraph = 5           # Maximum automatic links per paragraph
  minParagraphLength = 30                     # Minimum paragraph length to process

Example structure of /data/linkbuilding/[lang].yaml:
keywords:
  - keyword: "mcp"
    url: "/services/mcp-server-development/"
    exact: false
    priority: 1
    title: "We can develop and host your own MCP server"
  - keyword: "mcp server"
    url: "/services/mcp-server-development/"
    exact: false
    priority: 1
    title: "We can develop and host your own MCP server"
  - keyword: "mcp servers"
    url: "/services/mcp-server-development/"
    exact: false
    priority: 1
    title: "We can develop and host your own MCP server"

*/}}

{{ $content := .content }}
{{ $page := .page }}

{{/* Read linkbuilding settings from params.toml with fallback to defaults */}}
{{ $linkbuildingParams := $page.Site.Params.linkbuilding | default dict }}
{{ $maxSameKeywordReplacementsInPage := $linkbuildingParams.maxSameKeywordReplacementsInPage | default 50 }}
{{ $maxSameUrlReplacementsInPage := $linkbuildingParams.maxSameUrlReplacementsInPage | default 3 }}
{{ $maxKeywordUrlReplacementsInPage := $linkbuildingParams.maxKeywordUrlReplacementsInPage | default 1 }}
{{ $charactersPerLinkInParagraphDensity := $linkbuildingParams.charactersPerLinkInParagraphDensity | default 5 }}
{{ $maxAutomaticLinksInPage := $linkbuildingParams.maxAutomaticLinksInPage | default 50 }}
{{ $maxAutomaticLinksInParagraph := $linkbuildingParams.maxAutomaticLinksInParagraph | default 50 }}
{{ $minParagraphLength := $linkbuildingParams.minParagraphLength | default 30 }}

{{/* Load linkbuilding data for current language */}}
{{ $lang := $page.Lang | default "en" }}
{{ $linkbuildingData := index $page.Site.Data.linkbuilding $lang }}
{{ $keywords := $linkbuildingData.keywords | default slice }}

{{/* Initialize scratch for tracking link counts */}}
{{ $scratch := newScratch }}
{{ $scratch.Set "totalLinksInPage" 0 }}
{{ $scratch.Set "keywordCounts" dict }}
{{ $scratch.Set "urlCounts" dict }}
{{ $scratch.Set "keywordUrlCounts" dict }}

{{/* Get current page URL for comparison */}}
{{ $currentPageURL := $page.RelPermalink }}

{{/* Sort keywords by priority (higher priority first) and then by length (longer first) */}}
{{ $sortedKeywords := sort $keywords "priority" "desc" }}

{{/* Process content if we have keywords */}}
{{ if $keywords }}
  {{ $processedContent := $content }}

  {{/* Process each keyword */}}
  {{ range $sortedKeywords }}
    {{ $keyword := .keyword }}
    {{ $url := .url }}
    {{ $exact := .exact | default false }}
    {{ $title := .title | default "" }}

    {{/* Escape title for HTML attribute */}}
    {{ $escapedTitle := $title | htmlEscape }}

    {{/* Skip if target URL is same as current page */}}
    {{ if ne $url $currentPageURL }}
      {{/* Get current counts */}}
      {{ $totalLinks := $scratch.Get "totalLinksInPage" }}
      {{ $keywordCounts := $scratch.Get "keywordCounts" }}
      {{ $urlCounts := $scratch.Get "urlCounts" }}
      {{ $keywordUrlCounts := $scratch.Get "keywordUrlCounts" }}

      {{ $keywordCount := index $keywordCounts $keyword | default 0 }}
      {{ $urlCount := index $urlCounts $url | default 0 }}
      {{ $keywordUrlKey := printf "%s-%s" $keyword $url }}
      {{ $keywordUrlCount := index $keywordUrlCounts $keywordUrlKey | default 0 }}

      {{/* Check if we can add more links */}}
      {{ if and (lt $totalLinks $maxAutomaticLinksInPage) (lt $keywordCount $maxSameKeywordReplacementsInPage) (lt $urlCount $maxSameUrlReplacementsInPage) (lt $keywordUrlCount $maxKeywordUrlReplacementsInPage) }}

        {{/* Escape keyword for regex */}}
        {{ $escapedKeyword := replaceRE `([.*+?^${}()|[\]\\])` `\$1` $keyword }}
        {{ $pattern := $escapedKeyword }}
        {{ if $exact }}
          {{ $pattern = printf `\b%s\b` $escapedKeyword }}
        {{ end }}

        {{/* Case insensitive pattern */}}
        {{ $regexPattern := printf `(?i)%s` $pattern }}          {{/* Check if keyword exists in content */}}
          {{ if findRE $regexPattern $processedContent 1 }}

            {{/* Check if it's not already inside a link */}}
            {{ $keywordInLinkPattern := printf `(?i)<a\b[^>]*>[^<]*%s[^<]*</a>` $pattern }}
            {{ $keywordAlreadyLinked := findRE $keywordInLinkPattern $processedContent 1 }}

            {{/* Check if it's not inside heading tags */}}
            {{ $keywordInHeadingPattern := printf `(?i)<h[1-6]\b[^>]*>[^<]*%s[^<]*</h[1-6]>` $pattern }}
            {{ $keywordInHeading := findRE $keywordInHeadingPattern $processedContent 1 }}

            {{/* Check if keyword is inside any HTML tag attributes */}}
            {{ $keywordInTagPattern := printf `(?i)<[^>]*%s[^>]*>` $pattern }}
            {{ $keywordInTag := findRE $keywordInTagPattern $processedContent 1 }}

            {{ if not (or $keywordAlreadyLinked $keywordInHeading $keywordInTag) }}
              {{/* Find the actual matched text to preserve original case */}}
              {{ $matchedText := index (findRE $regexPattern $processedContent 1) 0 }}
              
              {{/* Create the replacement link using the matched text with underlined class */}}
              {{ $linkHtml := printf `<a href="%s" title="%s" class="underline">%s</a>` $url $escapedTitle $matchedText }}

              {{/* Replace only the first occurrence that matches exactly */}}
              {{ $processedContent = replaceRE $regexPattern $linkHtml $processedContent 1 }}

            {{/* Update counters */}}
            {{ $scratch.Set "totalLinksInPage" (add $totalLinks 1) }}
            {{ $keywordCounts = merge $keywordCounts (dict $keyword (add $keywordCount 1)) }}
            {{ $scratch.Set "keywordCounts" $keywordCounts }}
            {{ $urlCounts = merge $urlCounts (dict $url (add $urlCount 1)) }}
            {{ $scratch.Set "urlCounts" $urlCounts }}
            {{ $keywordUrlCounts = merge $keywordUrlCounts (dict $keywordUrlKey (add $keywordUrlCount 1)) }}
            {{ $scratch.Set "keywordUrlCounts" $keywordUrlCounts }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ $content = $processedContent }}
{{ end }}

{{ return $content }}