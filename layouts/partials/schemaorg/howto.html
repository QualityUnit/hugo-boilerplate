{{/*
@partial: Schema.org HowTo
@description: Generates JSON-LD structured data for step-by-step guides and tutorials
@params:
  - page: Page context (optional)
  - name: Name/title of the how-to guide
  - description: Description of the how-to
  - image: Featured image for the how-to
  - totalTime: Total time required (ISO 8601 duration format, e.g., "PT30M" for 30 minutes)
  - estimatedCost: Estimated cost (optional)
  - supply: Array of supplies needed (optional)
  - tool: Array of tools needed (optional)
  - steps: Array of step objects (required)
    - name: Step name/title
    - text: Step description
    - image: Step image (optional)
    - url: URL to step details (optional)
@example:
  {{ partial "schemaorg/howto.html" (dict
    "name" "How to Set Up Affiliate Program"
    "description" "Complete guide to setting up your affiliate program"
    "totalTime" "PT30M"
    "steps" $steps
  ) }}
@note: Steps should be an array of step objects with name and text fields
*/}}

{{/* Handle both direct page context and dict with page key */}}
{{ $page := . }}
{{ if reflect.IsMap . }}
  {{ if isset . "page" }}
    {{ $page = .page }}
  {{ end }}
{{ end }}
{{ $site := $page.Site }}

{{ $name := $page.Title }}
{{ $description := $page.Description }}
{{ $image := "" }}
{{ $steps := slice }}

{{ if reflect.IsMap . }}
  {{ $name = .name | default $page.Title }}
  {{ $description = .description | default $page.Description }}
  {{ $image = .image }}
  {{ $steps = .steps }}
{{ end }}

{{ if $steps }}
{{- $stepItems := slice -}}
{{- range $index, $step := $steps -}}
  {{- $item := dict "@type" "HowToStep" "position" (add $index 1) "name" $step.name "text" $step.text -}}
  {{- with $step.image }}{{ $item = merge $item (dict "image" (printf "%s%s" $site.BaseURL (strings.TrimPrefix "/" .))) }}{{ end -}}
  {{- with $step.url }}{{ $item = merge $item (dict "url" .) }}{{ end -}}
  {{- $stepItems = $stepItems | append $item -}}
{{- end -}}

{{- $schema := dict "@context" "https://schema.org" "@type" "HowTo" "name" $name "step" $stepItems -}}
{{- with $description }}{{ $schema = merge $schema (dict "description" .) }}{{ end -}}
{{- with $image -}}
  {{- $img := dict "@type" "ImageObject" "url" (printf "%s%s" $site.BaseURL (strings.TrimPrefix "/" .)) -}}
  {{- $schema = merge $schema (dict "image" $img) -}}
{{- end -}}
{{- with .totalTime }}{{ $schema = merge $schema (dict "totalTime" .) }}{{ end -}}
{{- with .estimatedCost -}}
  {{- $cost := dict "@type" "MonetaryAmount" "currency" (.currency | default "USD") "value" .value -}}
  {{- $schema = merge $schema (dict "estimatedCost" $cost) -}}
{{- end -}}
{{- with .supply -}}
  {{- $supplies := slice -}}
  {{- range . -}}
    {{- $supplies = $supplies | append (dict "@type" "HowToSupply" "name" .) -}}
  {{- end -}}
  {{- $schema = merge $schema (dict "supply" $supplies) -}}
{{- end -}}
{{- with .tool -}}
  {{- $tools := slice -}}
  {{- range . -}}
    {{- $tools = $tools | append (dict "@type" "HowToTool" "name" .) -}}
  {{- end -}}
  {{- $schema = merge $schema (dict "tool" $tools) -}}
{{- end -}}
<script type="application/ld+json">
{{- $schema | jsonify | safeJS -}}
</script>
{{ end }}