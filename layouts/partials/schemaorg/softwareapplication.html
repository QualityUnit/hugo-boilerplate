{{/*
@partial: Schema.org SoftwareApplication
@description: Generates JSON-LD structured data for software product/application
@params:
  - page: Page context (optional)
  - productName: Override product name (optional)
  - aggregateRating: Include aggregate rating data (optional)
@example:
  {{ partial "schemaorg/softwareapplication.html" . }}
  {{ partial "schemaorg/softwareapplication.html" (dict "page" . "aggregateRating" true) }}
@note: Requires site params configuration
  Config example in config.yaml:
    params:
      software:
        name: "Software Name"
        description: "Software description"
        applicationCategory: "BusinessApplication"
        operatingSystem: "Windows, macOS, Linux, Web"
        offers:
          price: "99.00"
          priceCurrency: "USD"
        screenshot: "/images/screenshot.png"
        softwareVersion: "1.0.0"
        releaseNotes: "https://example.com/release-notes"
        downloadUrl: "https://example.com/download"
        featureList: "Feature 1, Feature 2, Feature 3"
        requirements: "Modern web browser"
        aggregateRating:
          ratingValue: "4.8"
          reviewCount: "250"
          bestRating: "5"
*/}}

{{ $site := .Site }}

{{/* Handle both direct page context and dict with page key */}}
{{ $page := . }}
{{ if reflect.IsMap . }}
  {{ if isset . "page" }}
    {{ $page = .page }}
  {{ end }}
{{ end }}

{{ $software := $site.Params.software }}
{{ $productName := $site.Title }}

{{ if reflect.IsMap . }}
  {{ $productName = .productName | default $software.name | default $site.Title }}
{{ else }}
  {{ $productName = $software.name | default $site.Title }}
{{ end }}

{{ if $software }}
{{- $authorOrg := dict "@type" "Organization" "name" $site.Title "url" $site.BaseURL -}}
{{- $providerOrg := dict "@type" "Organization" "name" $site.Title "url" $site.BaseURL -}}

{{- $schema := dict "@context" "https://schema.org" "@type" "SoftwareApplication" "name" $productName "url" $site.BaseURL "author" $authorOrg "provider" $providerOrg -}}
{{- with $software.description }}{{ $schema = merge $schema (dict "description" .) }}{{ end -}}
{{- with $software.applicationCategory }}{{ $schema = merge $schema (dict "applicationCategory" .) }}{{ end -}}
{{- with $software.operatingSystem }}{{ $schema = merge $schema (dict "operatingSystem" .) }}{{ end -}}
{{- with $software.softwareVersion }}{{ $schema = merge $schema (dict "softwareVersion" .) }}{{ end -}}
{{- with $software.releaseNotes }}{{ $schema = merge $schema (dict "releaseNotes" .) }}{{ end -}}
{{- with $software.downloadUrl }}{{ $schema = merge $schema (dict "downloadUrl" .) }}{{ end -}}
{{- with $software.fileSize }}{{ $schema = merge $schema (dict "fileSize" .) }}{{ end -}}
{{- with $software.requirements }}{{ $schema = merge $schema (dict "requirements" .) }}{{ end -}}
{{- with $software.featureList }}{{ $schema = merge $schema (dict "featureList" .) }}{{ end -}}
{{- with $software.screenshot -}}
  {{- $img := dict "@type" "ImageObject" "url" (printf "%s%s" $site.BaseURL (strings.TrimPrefix "/" .)) -}}
  {{- $schema = merge $schema (dict "screenshot" $img) -}}
{{- end -}}
{{- with $software.offers -}}
  {{- $sellerOrg := dict "@type" "Organization" "name" $site.Title "url" $site.BaseURL -}}
  {{- $offer := dict "@type" "Offer" "url" $site.BaseURL "seller" $sellerOrg -}}
  {{- with .price }}{{ $offer = merge $offer (dict "price" .) }}{{ end -}}
  {{- with .priceCurrency }}{{ $offer = merge $offer (dict "priceCurrency" .) }}{{ end -}}
  {{- with .priceValidUntil }}{{ $offer = merge $offer (dict "priceValidUntil" .) }}{{ end -}}
  {{- with .availability }}{{ $offer = merge $offer (dict "availability" .) }}{{ else }}{{ $offer = merge $offer (dict "availability" "https://schema.org/InStock") }}{{ end -}}
  {{- $schema = merge $schema (dict "offers" $offer) -}}
{{- end -}}

{{- $showAggregateRating := false -}}
{{- if reflect.IsMap . -}}
  {{- $showAggregateRating = and .aggregateRating $software.aggregateRating -}}
{{- else -}}
  {{- $showAggregateRating = $software.aggregateRating -}}
{{- end -}}
{{- if and $showAggregateRating $software.aggregateRating -}}
  {{- with $software.aggregateRating -}}
    {{- $rating := dict "@type" "AggregateRating" -}}
    {{- with .ratingValue }}{{ $rating = merge $rating (dict "ratingValue" .) }}{{ end -}}
    {{- with .reviewCount }}{{ $rating = merge $rating (dict "reviewCount" .) }}{{ end -}}
    {{- with .bestRating }}{{ $rating = merge $rating (dict "bestRating" .) }}{{ end -}}
    {{- with .worstRating }}{{ $rating = merge $rating (dict "worstRating" .) }}{{ end -}}
    {{- $schema = merge $schema (dict "aggregateRating" $rating) -}}
  {{- end -}}
{{- end -}}
<script type="application/ld+json">
{{- $schema | jsonify | safeJS -}}
</script>
{{ end }}