{{/*
@partial: Schema.org Course
@description: Generates JSON-LD structured data for courses and learning resources
@params:
  - page: Page context (optional)
  - name: Course name (required)
  - description: Course description (required)
  - provider: Course provider (defaults to site title)
  - courseMode: "online", "onsite", or "blended"
  - educationalLevel: "Beginner", "Intermediate", "Advanced"
  - timeRequired: Duration in ISO 8601 format (e.g., "PT2H30M")
  - hasCourseInstance: Array of course instances with schedules
  - syllabus: Course syllabus sections
@example:
  {{ partial "schemaorg/course.html" (dict
    "name" "Affiliate Marketing Fundamentals"
    "description" "Learn the basics of affiliate marketing"
    "courseMode" "online"
    "educationalLevel" "Beginner"
    "timeRequired" "PT4H"
  ) }}

  From frontmatter (academy pages):
    {{ partial "schemaorg/course.html" . }}
@note: Perfect for academy/training content sections
*/}}

{{ $site := .Site }}

{{/* Handle both direct page context and dict with page key */}}
{{ $page := . }}
{{ if reflect.IsMap . }}
  {{ if isset . "page" }}
    {{ $page = .page }}
  {{ end }}
{{ end }}

{{ $name := $page.Title }}
{{ $description := $page.Description }}
{{ if reflect.IsMap . }}
  {{ $name = .name | default $page.Title }}
  {{ $description = .description | default $page.Description }}
{{ end }}

{{ if and $name $description }}
{{- $providerOrg := dict "@type" "Organization" "name" (.provider | default $site.Title) "url" $site.BaseURL -}}
{{- with $site.Params.organization.logo -}}
  {{- $logo := dict "@type" "ImageObject" "url" (printf "%s%s" $site.BaseURL (strings.TrimPrefix "/" .)) -}}
  {{- $providerOrg = merge $providerOrg (dict "logo" $logo) -}}
{{- end -}}

{{- $schema := dict "@context" "https://schema.org" "@type" "Course" "name" $name "description" $description "provider" $providerOrg "url" ($page.Permalink | default $site.BaseURL) -}}
{{- with .image -}}
  {{- $img := dict "@type" "ImageObject" "url" (printf "%s%s" $site.BaseURL (strings.TrimPrefix "/" .)) -}}
  {{- $schema = merge $schema (dict "image" $img) -}}
{{- end -}}
{{- with .courseMode }}{{ $schema = merge $schema (dict "courseMode" .) }}{{ end -}}
{{- with .educationalLevel }}{{ $schema = merge $schema (dict "educationalLevel" .) }}{{ end -}}
{{- with .timeRequired }}{{ $schema = merge $schema (dict "timeRequired" .) }}{{ end -}}
{{- with .numberOfLessons }}{{ $schema = merge $schema (dict "numberOfLessons" .) }}{{ end -}}
{{- with .inLanguage }}{{ $schema = merge $schema (dict "inLanguage" .) }}{{ else }}{{ $schema = merge $schema (dict "inLanguage" $site.Language.Lang) }}{{ end -}}
{{- with .audience -}}
  {{- $schema = merge $schema (dict "audience" (dict "@type" "Audience" "audienceType" .)) -}}
{{- end -}}
{{- with .teaches }}{{ $schema = merge $schema (dict "teaches" .) }}{{ end -}}
{{- with .coursePrerequisites }}{{ $schema = merge $schema (dict "coursePrerequisites" .) }}{{ end -}}
{{- with .syllabus -}}
  {{- $sections := slice -}}
  {{- range . -}}
    {{- $section := dict "@type" "Syllabus" "name" .name -}}
    {{- with .description }}{{ $section = merge $section (dict "description" .) }}{{ end -}}
    {{- with .timeRequired }}{{ $section = merge $section (dict "timeRequired" .) }}{{ end -}}
    {{- $sections = $sections | append $section -}}
  {{- end -}}
  {{- $schema = merge $schema (dict "syllabusSections" $sections) -}}
{{- end -}}
{{- with .hasCourseInstance -}}
  {{- $instances := slice -}}
  {{- range . -}}
    {{- $inst := dict "@type" "CourseInstance" "courseWorkload" (.courseWorkload | default "Self-paced") -}}
    {{- with .courseMode }}{{ $inst = merge $inst (dict "courseMode" .) }}{{ end -}}
    {{- with .startDate }}{{ $inst = merge $inst (dict "startDate" .) }}{{ end -}}
    {{- with .endDate }}{{ $inst = merge $inst (dict "endDate" .) }}{{ end -}}
    {{- with .instructor -}}
      {{- $instr := dict "@type" "Person" "name" .name -}}
      {{- with .image }}{{ $instr = merge $instr (dict "image" .) }}{{ end -}}
      {{- $inst = merge $inst (dict "instructor" $instr) -}}
    {{- end -}}
    {{- $instances = $instances | append $inst -}}
  {{- end -}}
  {{- $schema = merge $schema (dict "hasCourseInstance" $instances) -}}
{{- end -}}
{{- with .offers -}}
  {{- $offer := dict "@type" "Offer" "availability" (.availability | default "https://schema.org/InStock") "url" ($page.Permalink | default $site.BaseURL) -}}
  {{- with .price }}{{ $offer = merge $offer (dict "price" .) }}{{ end -}}
  {{- with .priceCurrency }}{{ $offer = merge $offer (dict "priceCurrency" .) }}{{ end -}}
  {{- $schema = merge $schema (dict "offers" $offer) -}}
{{- end -}}
{{- with .aggregateRating -}}
  {{- $schema = merge $schema (dict "aggregateRating" (dict "@type" "AggregateRating" "ratingValue" .ratingValue "reviewCount" .reviewCount)) -}}
{{- end -}}
<script type="application/ld+json">
{{- $schema | jsonify | safeJS -}}
</script>
{{ end }}