{{/*
@partial: Schema.org FAQ Consolidated
@description: Renders a single FAQPage schema with all accumulated FAQ items from the page
@params:
  - Context should be the page itself (.)
@example:
  {{ partial "schemaorg/faq-consolidated.html" . }}
@note: This should be called once per page, typically in baseof.html before </body>.
       It will output nothing if no FAQs have been accumulated.
*/}}

{{ $page := . }}

{{/* Get all accumulated FAQs from site store using page-specific key */}}
{{ $storeKey := printf "faq_%s" $page.RelPermalink }}
{{ $allFaqs := site.Store.Get $storeKey | default slice }}

{{/* Fallback: if nothing was accumulated but page has faq in frontmatter, use that */}}
{{ if and (eq (len $allFaqs) 0) $page.Params.faq }}
  {{ $allFaqs = $page.Params.faq }}
{{ end }}

{{/* Only output schema if we have FAQs */}}
{{ if and $allFaqs (gt (len $allFaqs) 0) }}
{{- $mainEntity := slice -}}
{{- range $allFaqs -}}
  {{- $answer := dict "@type" "Answer" "text" .answer -}}
  {{- $question := dict "@type" "Question" "name" .question "acceptedAnswer" $answer -}}
  {{- $mainEntity = $mainEntity | append $question -}}
{{- end -}}
{{- $schema := dict "@context" "https://schema.org" "@type" "FAQPage" "mainEntity" $mainEntity -}}
<!-- Schema.org FAQPage markup (consolidated) -->
<script type="application/ld+json">
{{- $schema | jsonify | safeJS -}}
</script>
{{ end }}