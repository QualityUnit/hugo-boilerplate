{{/*
@partial: Schema.org Discussion Forum Posting
@description: Generates JSON-LD structured data for Reddit-style discussion pages
              using schema.org DiscussionForumPosting type for better AI discoverability.
@params:
  - page: The page context (required)
@example:
  {{ partial "schemaorg/discussion.html" . }}
@note: Generates DiscussionForumPosting structured data optimized for AI citation
*/}}

{{ $page := . }}
{{ $site := $page.Site }}

{{/* Get discussion metadata from frontmatter */}}
{{ $username := "" }}
{{ $role := "" }}
{{ $verified := false }}
{{ with $page.Params.op }}
  {{ $username = .username | default "Community Member" }}
  {{ $role = .role | default "" }}
  {{ $verified = .verified | default false }}
{{ end }}

{{ $upvotes := $page.Params.upvotes | default 0 }}
{{ $commentCount := $page.Params.commentCount | default 0 }}

{{- $authorObj := dict "@type" "Person" "name" $username -}}
{{- if $role }}{{ $authorObj = merge $authorObj (dict "jobTitle" $role) }}{{ end -}}

{{- $likeCounter := dict "@type" "InteractionCounter" "interactionType" "https://schema.org/LikeAction" "userInteractionCount" $upvotes -}}
{{- $commentCounter := dict "@type" "InteractionCounter" "interactionType" "https://schema.org/CommentAction" "userInteractionCount" $commentCount -}}

{{- $forum := dict "@type" "DiscussionForum" "name" (printf "%s Community Discussions" $site.Title) "url" (printf "%sdiscussion/" $site.BaseURL) "description" "Community discussions about AI visibility, brand monitoring, and content strategy" -}}

{{- $mainEntity := dict "@type" "WebPage" "@id" $page.Permalink -}}

{{- $publisherLogo := dict "@type" "ImageObject" "url" (printf "%simages/logo.png" $site.BaseURL) -}}
{{- $publisher := dict "@type" "Organization" "name" $site.Title "url" $site.BaseURL "logo" $publisherLogo -}}

{{- $schema := dict "@context" "https://schema.org" "@type" "DiscussionForumPosting" "@id" $page.Permalink "headline" $page.Title "text" ($page.Description | default $page.Summary | plainify) "url" $page.Permalink "datePublished" ($page.Date.Format "2006-01-02T15:04:05-07:00") "dateModified" ($page.Lastmod.Format "2006-01-02T15:04:05-07:00") "author" $authorObj "interactionStatistic" (slice $likeCounter $commentCounter) "discussionUrl" $page.Permalink "isPartOf" $forum "mainEntityOfPage" $mainEntity "publisher" $publisher -}}
{{- with $page.Params.tags }}{{ $schema = merge $schema (dict "keywords" .) }}{{ end -}}
{{- with $page.Params.image }}{{ $schema = merge $schema (dict "image" (printf "%s%s" $site.BaseURL (strings.TrimPrefix "/" .))) }}{{ end -}}
<!-- Schema.org structured data for discussion forum posting -->
<script type="application/ld+json">
{{- $schema | jsonify | safeJS -}}
</script>

{{/* Accumulate FAQ items for consolidated schema output */}}
{{ if $page.Params.faq }}
{{ partial "schemaorg/faq-accumulator.html" (dict "faqs" $page.Params.faq "page" $page) }}
{{ end }}