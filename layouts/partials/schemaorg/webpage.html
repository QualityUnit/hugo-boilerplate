{{/*
@partial: Schema.org WebPage
@description: Generates JSON-LD structured data for various webpage types
@params:
  - page: Page context (required)
  - pageType: Type of page - "WebPage", "AboutPage", "ContactPage", "FAQPage", "CollectionPage", "ProfilePage", "SearchResultsPage" (optional, auto-detected or defaults to WebPage)
@example:
  {{ partial "schemaorg/webpage.html" . }}
  {{ partial "schemaorg/webpage.html" (dict "page" . "pageType" "AboutPage") }}
@note: Automatically detects page type from page params or URL
  Set pageType in frontmatter: pageType: "AboutPage"
*/}}

{{/* Handle both direct page context and dict with page key */}}
{{ $page := . }}
{{ if reflect.IsMap . }}
  {{ if isset . "page" }}
    {{ $page = .page }}
  {{ end }}
{{ end }}
{{ $site := $page.Site }}

{{/* Auto-detect page type */}}
{{ $pageType := "WebPage" }}
{{ if reflect.IsMap . }}
  {{ $pageType = .pageType | default $page.Params.pageType | default "WebPage" }}
{{ else }}
  {{ $pageType = $page.Params.pageType | default "WebPage" }}
{{ end }}

{{/* Auto-detect based on page path if not specified */}}
{{ if eq $pageType "WebPage" }}
  {{ $relPath := strings.ToLower $page.RelPermalink }}
  {{ if or (in $relPath "/about") (in $relPath "/about-us") }}
    {{ $pageType = "AboutPage" }}
  {{ else if or (in $relPath "/contact") (in $relPath "/contact-us") }}
    {{ $pageType = "ContactPage" }}
  {{ else if or (in $relPath "/search") (in $relPath "/results") }}
    {{ $pageType = "SearchResultsPage" }}
  {{ else if $page.IsHome }}
    {{ $pageType = "WebPage" }}
  {{ end }}
{{ end }}

{{/* Build breadcrumb list */}}
{{- $breadcrumbs := slice (dict "name" "Home" "url" $site.BaseURL) -}}
{{- $ancestors := $page.Ancestors.Reverse -}}
{{- range $ancestors -}}
  {{- if not .IsHome -}}
    {{- $breadcrumbs = $breadcrumbs | append (dict "name" .Title "url" .Permalink) -}}
  {{- end -}}
{{- end -}}
{{- if not $page.IsHome -}}
  {{- $breadcrumbs = $breadcrumbs | append (dict "name" $page.Title "url" $page.Permalink) -}}
{{- end -}}

{{- $breadcrumbItems := slice -}}
{{- range $i, $crumb := $breadcrumbs -}}
  {{- $breadcrumbItems = $breadcrumbItems | append (dict "@type" "ListItem" "position" (add $i 1) "name" $crumb.name "item" $crumb.url) -}}
{{- end -}}
{{- $breadcrumbList := dict "@type" "BreadcrumbList" "@id" (printf "%s#breadcrumb" $page.Permalink) "itemListElement" $breadcrumbItems -}}

{{- $isPartOf := dict "@type" "WebSite" "@id" (printf "%s#website" $site.BaseURL) "url" $site.BaseURL "name" $site.Title -}}

{{- $publisher := dict "@type" "Organization" "name" $site.Title "url" $site.BaseURL -}}
{{- with $site.Params.organization.logo -}}
  {{- $logo := dict "@type" "ImageObject" "url" (printf "%s%s" $site.BaseURL (strings.TrimPrefix "/" .)) -}}
  {{- $publisher = merge $publisher (dict "logo" $logo) -}}
{{- end -}}

{{- $schema := dict "@context" "https://schema.org" "@type" $pageType "@id" $page.Permalink "url" $page.Permalink "name" $page.Title "inLanguage" $page.Language.Lang "isPartOf" $isPartOf "datePublished" ($page.Date.Format "2006-01-02T15:04:05Z07:00") "dateModified" ($page.Lastmod.Format "2006-01-02T15:04:05Z07:00") "breadcrumb" $breadcrumbList "publisher" $publisher -}}
{{- with $page.Description }}{{ $schema = merge $schema (dict "description" .) }}{{ end -}}
{{- with $page.Params.image -}}
  {{- $img := dict "@type" "ImageObject" "url" (printf "%s%s" $site.BaseURL (strings.TrimPrefix "/" .)) -}}
  {{- $schema = merge $schema (dict "image" $img) -}}
{{- end -}}
{{- with $page.Params.author -}}
  {{- $authorKey := . -}}
  {{- $authors := $site.Data.authors -}}
  {{- if and $authors (index $authors $authorKey) -}}
    {{- $author := index $authors $authorKey -}}
    {{- $schema = merge $schema (dict "author" (dict "@type" "Person" "name" $author.name)) -}}
  {{- end -}}
{{- end -}}
<script type="application/ld+json">
{{- $schema | jsonify | safeJS -}}
</script>