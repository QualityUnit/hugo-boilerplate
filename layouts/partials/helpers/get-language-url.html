{{/*
@helper: Get Language URL
@description: Returns the URL for a given language code using precomputed translation URLs
@params:
  .code (string): The language code (e.g., "en", "de", "es")
  .langData (object): Language data object from all_languages.yaml
  .currentPage (Page): The current Hugo page object
  .filePath (string): The file path relative to content directory (optional)
  .permalink (string): Direct permalink override (optional)
@returns: The full URL for the specified language
*/}}

{{ $code := .code }}
{{ $langData := .langData }}
{{ $currentPage := .currentPage }}
{{ $filePath := .filePath }}
{{ $permalink := .permalink }}
{{ $currentLangCode := $currentPage.Language.Lang }}

{{ $href := "" }}

{{ if $langData }}
  {{/* Set up base domain */}}
  {{ $baseDomain := $langData.baseDomainName }}
  {{ if (in $currentPage.Permalink "localhost") }}
    {{ $baseDomain = "" }}
  {{ end }}
  
  {{/* Default URL using language base URL */}}
  {{ $href = printf "%s%s" $baseDomain $langData.baseURL }}
  
  {{/* Try to load from precomputed translation URLs */}}
  {{ if $filePath }}
    {{/* Clean up file path - remove language prefix if present */}}
    {{ $cleanFilePath := $filePath }}
    {{ $langPrefix := printf "%s/" $currentLangCode }}
    {{ if hasPrefix $cleanFilePath $langPrefix }}
      {{ $cleanFilePath = strings.TrimPrefix $langPrefix $cleanFilePath }}
    {{ end }}
    
    {{/* Determine folder from file path */}}
    {{ $folder := "_root" }}
    {{ $pathParts := split $cleanFilePath "/" }}
    {{ if gt (len $pathParts) 1 }}
      {{ $folder = index $pathParts 0 }}
    {{ end }}
    
    {{/* Load translation URLs directly without partialCached to avoid issues */}}
    {{ $folderKey := replace $folder "-" "_" }}
    {{ $translationUrls := site.Data.translation_urls }}
    {{ if $translationUrls }}
      {{ $folderData := index $translationUrls $folderKey }}
      {{ if $folderData }}
        {{/* Get translation data for this specific file */}}
        {{ $translationData := index $folderData $cleanFilePath }}
        {{ if $translationData }}
          {{/* Get URL for the requested language */}}
          {{ $translatedUrl := index $translationData $code }}
          {{ if $translatedUrl }}
            {{/* Use the precomputed URL from JSON */}}
            {{/* For custom domains (baseURL="/"), remove language prefix from URL */}}
            {{ $cleanUrl := $translatedUrl }}
            {{ if eq $langData.baseURL "/" }}
              {{ $langPrefix := printf "/%s/" $code }}
              {{ if hasPrefix $cleanUrl $langPrefix }}
                {{ $cleanUrl = strings.TrimPrefix $langPrefix $cleanUrl }}
                {{ if not $cleanUrl }}
                  {{ $cleanUrl = "/" }}
                {{ end }}
              {{ end }}
            {{ end }}
            {{ $href = printf "%s%s" $baseDomain $cleanUrl }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ else if $permalink }}
  {{ $href = $permalink }}
{{ end }}

{{ return $href }}