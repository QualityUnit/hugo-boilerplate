{{/*
@component: YouTube Video
@description: Displays YouTube videos with optimized lazy-loading functionality and thumbnail images that load only when displayed on screen.
@params:
  - videoID: YouTube video ID (required)
  - title: Video title for better accessibility (required)
  - class: Additional CSS classes (optional)
  - width: Video width (optional, default: "100%")
  - height: Video height (optional, default: "auto")
  - id: Optional ID attribute (optional, default: "youtube-{videoID}")
@example:
  {{ partial "components/media/youtubevideo.html" (dict 
      "videoID" "dQw4w9WgXcQ" 
      "title" "Rick Astley - Never Gonna Give You Up" 
      "class" "my-8 rounded-xl shadow-lg"
  ) }}
@note: The component automatically finds the highest quality available thumbnail image and implements lazy-loading for better page performance.
*/}}

{{ $videoID := .videoID }}
{{ $title := .title | default "YouTube Video" }}
{{ $class := .class | default "" }}
{{ $width := .width | default "100%" }}
{{ $height := .height | default "auto" }}
{{ $id := .id | default (print "youtube-" $videoID) }}
{{ $description := .description | default $title }}
{{ $uploadDate := .uploadDate | default (now.Format "2006-01-02T15:04:05Z07:00") }}
{{ $duration := .duration | default "PT0M0S" }}

<!-- Schema.org VideoObject metadata -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "VideoObject",
  "name": {{ $title }},
  "description": {{ $description }},
  "thumbnailUrl": "https://img.youtube.com/vi/{{ $videoID }}/maxresdefault.jpg",
  "uploadDate": {{ $uploadDate }},
  "duration": {{ $duration }},
  "contentUrl": "https://www.youtube.com/watch?v={{ $videoID }}",
  "embedUrl": "https://www.youtube.com/embed/{{ $videoID }}"
}
</script>

<div 
  class="relative w-full overflow-hidden rounded-lg shadow-md {{ with $class }}{{ . }}{{ end }}"
  data-video-id="{{ $videoID }}"
  data-video-title="{{ $title }}"
  data-video-width="{{ $width }}"
  data-video-height="{{ $height }}"
  {{ with $id }}id="{{ . }}"{{ end }}
>
  <div class="lazy-video-thumbnail relative w-full video-aspect-ratio overflow-hidden cursor-pointer">
    <img 
      src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 9'%3E%3C/svg%3E"
      data-src="https://img.youtube.com/vi/{{ $videoID }}/maxresdefault.jpg"
      alt="Thumbnail for {{ $title }}"
      class="lazy-video-thumb-img lazy-image absolute inset-0 w-full h-full object-cover transition-transform duration-300"
      data-video-id="{{ $videoID }}"
      loading="lazy"
      decoding="async"
      width="{{ $width }}"
      height="{{ $height }}"
      onload="this.onload=null; if(this.dataset.src === this.src) findBestThumbnail(this);"
    />
  </div>
    <div class="lazy-video-play-button absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-16 h-12 bg-red-600 rounded-lg flex items-center justify-center transition-all duration-300 hover:bg-red-700 hover:scale-110 z-10">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-white ml-1">
        <path d="M8 5v14l11-7z"/>
      </svg>
    </div>
  <div class="lazy-video-iframe-container relative w-full video-aspect-ratio hidden">
    <!-- YouTube iframe will be inserted here when clicked -->
  </div>
</div>

<!-- Dynamic CSS and script loading for YouTube video functionality -->
<script>
  // Dynamically load YouTube video CSS and JS only when needed
  (function() {
    // Load CSS first
    if (!window.youtubeVideoCSSLoaded) {
      const cssLink = document.createElement('link');
      cssLink.rel = 'stylesheet';
      cssLink.href = '/css/youtube-video.css{{ with partialCached "helpers/build-timestamp.html" . }}?v={{ . }}{{ end }}';
      document.head.appendChild(cssLink);
      window.youtubeVideoCSSLoaded = true;
    }
    
    // Then load JS
    if (!window.youtubeVideoLoaded && !window.youtubeVideoLoading) {
      window.youtubeVideoLoading = true;
      
      const script = document.createElement('script');
      script.src = '/js/youtube-video.js{{ with partialCached "helpers/build-timestamp.html" . }}?v={{ . }}{{ end }}';
      script.onload = function() {
        window.youtubeVideoLoaded = true;
        window.youtubeVideoLoading = false;
      };
      script.onerror = function() {
        window.youtubeVideoLoading = false;
        console.error('Failed to load YouTube video script');
      };
      document.head.appendChild(script);
    }
  })();

  // Only keep the onload handler for thumbnail optimization
  function findBestThumbnail(img) {
    // Wait for script to load if it's still loading
    function waitForScript() {
      if (window.findBestThumbnail && typeof window.findBestThumbnail === 'function') {
        window.findBestThumbnail(img);
      } else if (!window.youtubeVideoLoading) {
        // Script failed to load, provide fallback
        console.warn('YouTube video script not loaded, using fallback');
      } else {
        // Still loading, check again in 100ms
        setTimeout(waitForScript, 100);
      }
    }
    waitForScript();
  }
</script>
