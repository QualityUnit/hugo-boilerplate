{{/*
@component: Lazy Image
@description: Directs to the appropriate lazy image loading component based on URL type. For images only.
@params:
  - src: Path to the source image (required)
  - alt: Alternative text for accessibility (required)
  - description: Text under the image
  - class: Additional CSS classes (optional)
  - figureClass: Additional CSS classes for figure element (optional)
  - id: Image ID (optional)
  - width: Image width (optional)
  - height: Image height (optional)
  - maxWidth: Maximum image width for loading (optional)
  - noLazy: Set to true to disable lazy loading (for hero images, above-the-fold content) (optional)
  - link: URL to wrap the image in a clickable link (optional)
  - linkTarget: Target attribute for link, e.g. "_blank" (optional, defaults to "_self" if link is set)
  - linkRel: Rel attribute for link, e.g. "nofollow" (optional, auto-adds "noopener noreferrer" for _blank)
  - linkTitle: Title attribute for link (optional)
@example:
  {{ partial "components/media/lazyimg.html" (dict 
      "src" "/images/example.jpg" 
      "alt" "Example image" 
      "description" "Source: <a href='https://www.shutterstock.com/'>Shutterstock</a>"
      "class" "rounded-lg shadow-md"
      "figureClass" "size-full"
  ) }}
  
  {{ partial "components/media/lazyimg.html" (dict 
      "src" "/images/hero-banner.jpg" 
      "alt" "Hero banner" 
      "class" "hero-image"
      "figureClass" "size-large"
      "noLazy" true
  ) }}
*/}}

{{ $src := .src }}
{{ $description := .description }}
{{ $figureClass := .figureClass | default "" }}
{{ $link := .link | default "" }}
{{ $linkTarget := .linkTarget | default "" }}
{{ $linkRel := .linkRel | default "" }}
{{ $linkTitle := .linkTitle | default "" }}

{{/* Build rel attribute: user-provided rel + auto noopener noreferrer for _blank */}}
{{ $finalRel := $linkRel }}
{{ if eq $linkTarget "_blank" }}
  {{ if $finalRel }}
    {{ $finalRel = printf "%s noopener noreferrer" $finalRel }}
  {{ else }}
    {{ $finalRel = "noopener noreferrer" }}
  {{ end }}
{{ end }}

{{ $figureClasses := "text-center" }}
{{ if $figureClass }}
  {{ $figureClasses = printf "%s %s" $figureClasses $figureClass }}
{{ end }}

<figure class="{{ $figureClasses }}">
  {{ if $link }}<a href="{{ $link }}"{{ if $linkTarget }} target="{{ $linkTarget }}"{{ end }}{{ if $finalRel }} rel="{{ $finalRel }}"{{ end }}{{ if $linkTitle }} title="{{ $linkTitle }}"{{ end }}>{{ end }}
  {{ if $src }}
    {{ if or (hasPrefix $src "http://") (hasPrefix $src "https://") }}
      {{ partial "components/media/lazyimg_external.html" . }}
    {{ else }}
      {{ partial "components/media/lazyimg_internal.html" . }}
    {{ end }}
  {{ end }}
  {{ if $link }}</a>{{ end }}
  {{ if $description }}
    <figcaption>{{ $description | safeHTML }}</figcaption>
  {{ end }}
</figure>
